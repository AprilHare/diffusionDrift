{% extends "layout.html" %}
{% block subtitle %} Working {% endblock %}
{% block includes %} 

{% endblock %}
{% block body %}
{% include "form.html" %} 



<div id="plot"></div>
<div id="histogramx"></div>

<div id="histogramy"></div>

<script src="//d3js.org/d3.v3.min.js"></script>

<style>

body {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.dot {
  stroke: #000;}


.noticklabel text{
  display: none;
}

#histogramx text{
  color: #FFFFFF;
}

.bar {
  opacity: 0.2;
}


.bar_histy {
  opacity: 0.2;
}

</style>

<script>

var color = d3.scale.category10(),
    formatCount = d3.format(",.0f"),
    i = 1,//  set your counter to 1
    width = 750,
    height = 750;

var data = JSON.parse({{ diff|tojson }});

data.forEach(function(d) {
  d.y = +d.y;
  d.x = +d.x;
});

var JSONhist = JSON.parse({{ hist|tojson }});


console.log('max(hist.x): ' + (d3.max(JSONhist['x'], function(d) { return (d.x); })+JSONhist['x'][1]['dx']));
console.log('max(hist.y): ' + d3.min(JSONhist['y'], function(d) { return (d.x); }));
console.log('binsize: ' + JSONhist['x'][1]['dx']);
console.log('max(data.x): '+ d3.max(data, function(d) { return (d.x); }));
console.log('max(data.y): '+ d3.min(data, function(d) { return (d.y); }));





//define mappings

//mapping based on scatter data:

var x = d3.scale.linear()
    .range([0, width-250])
    .domain(d3.extent(data, function(d) { return d.x; }));

var y = d3.scale.linear()
    .range([height-250, 0])
    .domain(d3.extent(data, function(d) { return d.y; }));

//define dimensions of the histograms

var width_hist = 500 ,
    height_hist = 200;

var width_histy = 500,
    height_histy = 200;

//define mappings

domain_x = [0, d3.max(JSONhist['x'], function(d) { return (d.x); }) - d3.min(JSONhist['x'], function(d) { return (d.x); })]

var width_mapping = d3.scale.linear()
    .domain(domain_x)
    .range([0, 500]);

var y_hist = d3.scale.linear()
    .domain([0, d3.max(JSONhist['x'], function(d) { return (d.y); })])
    .range([0, height_hist]);

var y_histy = d3.scale.linear()
    .domain([0, d3.max(JSONhist['y'], function(d) { return (d.y); })])
    .range([height_histy, 0]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left");

var diffusion = d3.select("#plot").append("svg")
    .attr("width", width)
    .attr("height", height)
  .append("g");

//##define axis
diffusion.append("g")
  .attr("class", "x axis noticklabel")
  .attr("transform", "translate(0," + (height-250)+ ")")
  .call(xAxis)
  
diffusion.append("g")
  .attr("class", "y axis")
  .call(yAxis)
  .attr("transform", "translate(" + 25+ ",0)")
.append("text")
  .attr("class", "label")
  .attr("transform", "rotate(-90)")
  .attr("y", 6)
  .attr("x", (-height+290))
  .attr("dy", ".71em")
  .style("text-anchor", "end")
  .text("y position")

diffusion.append("g")
  .attr("class", "x axis")
  .call(xAxis)
.append("text")
  .attr("class", "label")
  .attr("x", (width-250))
  .attr("y", (-6))
  .style("text-anchor", "end")
  .text("x position");

diffusion.append("g")
  .attr("class", "y axis noticklabel")
  .attr("transform", "translate(" + (width-250) + ",0)")
  .call(yAxis)


function update(data,i) {
    diffusion.selectAll(".dot").remove()
    diffusion.selectAll(".dot")
      .data(data)
      .enter().append("circle")
      .filter(function(d) { return d.t == i})
      .attr("class", "dot")
      .attr("r", 3.5)
      .attr("cx", function(d) { return x(d.x); })
      .attr("cy", function(d) { return y(d.y); })
}



function myLoop () {           //  create a loop function
     setTimeout(function () {    //  call a 3s setTimeout when the loop is called
        update(data, i);         //  your code here
        i++;                     //  increment the counter
        if (i <= {{time}}-1) {            //  if the counter < 10, call the loop function 
           draw_hist(x, y,i);
           myLoop();            //  ..  again which will trigger another 
        }                        //  ..  setTimeout()
     }, 1)
}
                    //  start the loop
myLoop()
// update(data, {{time}}-1);
// draw_hist(x, y, {{time}}-1);


function draw_hist (values_hist, values_histy,i) { 

    diffusion.selectAll(".bar").remove()
    diffusion.selectAll(".bar_histy").remove()
    // A formatter for counts.
    var bar_hist = diffusion.selectAll(".bar")
    .data(JSONhist['x'])
    .enter().append("g")
    .attr("class", "bar")
    .filter(function(d) { return d.t == i})
    .attr("transform", function(d) { return "translate(" + x(d.x) + "," + y_hist(d.y) + ")"; });

    var bar_histy = diffusion.selectAll(".bar_histy")
    .data(JSONhist['y'])
    .enter().append("g")
    .attr("class", "bar_histy")
    .filter(function(d) { return d.t == i})
    .attr("transform", function(d) { return "translate(" + y_histy(d.y) + "," + y(d.x+d.dx) + ")"; });

    bar_hist.append("rect")
        .attr("x", 0)
        .attr("y", function(d) { return height_hist - y_hist(d.y) +300; })
        .attr("width", width_mapping(JSONhist['x'][0].dx)  )
        .attr("height", function(d) { return y_hist(d.y*4); });

    bar_histy.append("rect")
        .attr("x",  function(d) { return 500 - y_histy(d.y); })
        .attr("y", 0)
        .attr("width", function(d) { return height_histy - y_histy(d.y*4); })
        .attr("height", width_mapping(JSONhist['x'][0].dx) );
}

</script>



{% endblock %}



